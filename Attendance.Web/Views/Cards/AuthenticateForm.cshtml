@model AuthenticateFormViewModel
@{
    double date = 0;
}
@section styles{
    @*<link href="~/Content/select2.min.css" rel="stylesheet" />*@
}
<div class="animate__animated animate__fadeIn animate__slow">

    <form action="/cards/submitform" method="post">
        @Html.HiddenFor(x => x.cardId)
        @Html.HiddenFor(x => x.Car)
        @Html.HiddenFor(x => x.Driver)
        @Html.HiddenFor(x => x.LoginId)
        <div class="row">
            <div class=" text-center">
                <img class="card-img" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAYAAADimHc4AAAABmJLR0QA/wD/AP+gvaeTAAAJLUlEQVR4nO2dW5AUZxXHf+frWSACglxCqiQoldpdiFqpBEhCJCJIVS4QQCTDXihI1Dd8NLKwi7Ys4SJllRXLSuUhJtyWZVJqwApGWdmykphy1ZiU0WIXKlpBC4wgCct9Zvr4MDNkbwzTM909Mz37e1lm9utzDv//9Ne93d+cFkqU7Robdw2nxsKpdWCGIDXA7SCjQUcDnwJGp4dfBM6BXAS9CJxUtMfAsSSmewSmp0miHxXr/5INKXYBGWyNjbHQ+8FZZJBFit4NGA9TvAd0gHRYJDs2SOM5D2PnTVENsPWF8VXcEnXQ1QIPAFZAqZOgbyiyN8mVl2x58sOA8g4icANstU0VtY84sEZgKTAq6BoGcEXhEDi7khx/1RbbCTJ5YAbYapsINYtBbOCeoPK65G+C/CDOlDZbFiSCSOi7AbZ2Rqo49YQiTcAdfufziBMK25PctstvI3w1YIvunw08C8z2M4+PvGMw6zbKqjf8SuCLAbbGJkRIfg/4Ft6eyRQDBfYmiH/bljUfeB3ccwNatW25IM8DE7yOXWTOgnyjReoOehnUMwNs7YxYnN4i8B0v45YYCvw4gfWULdFrXgT0RKhWjU03JA8ozPEiXhnQZcGqDVL/z0IDFWxA+kB7GJhcaKwy438GXbJRGt4sJEhBB8hWbVsIepTKEx9ggoMcadW2hwsJkrcBrdq+QpDDIGMLKaDMGS3IwS3aVp9vgLymoFRC2Uv5n2J6hSNIY7PUtbvd0LUBT+v+ryi8Aox0u23IiQvOY83S+Gs3G7kyYLO2zzGpOX+Mq9Iqh0sGXeTmwJyzAa0amy4ku4BJeZVWOfzXgntzPUXNaQ5/Tp+rguQ+hsXPhckOxGyNjchlcE4GnGHsToG5hdVVOSjMiZDYlsvYm05Brdq+RNBDuYwdph+q6IpN0vBytkFZRd2qsckOyWOE78JaUJxNoDNsaThzowFZpyCHxA6GxS+EiRFM1qnohnvAVj3wRQfntWxjhskJx6DzbnRqOuQeYGtnxMH5CcPie4FxMM/Z2hkZ8pdDvWlx+kngLl/Lqij0C1WcXjPUbwYZENOYJfCU/0WVFwbDbKqRPCcFhY1D7QWDDOjBqQOq88oSUgRhKffxELP4KnMx+ZlwR4RTjw98s58BqiqgTfkWGkYEYRn38zk+A8BMprE8fxNabLX7ad7vxVbaHwU+n2+xYWOg+BnyN0HurGLGQ33f6b8HwNr8Sg0fBsMKHhgkfoaZTOMx7nN9THBw+h2MrxuwXWPjgCV51Bo6MnP+DG7POu4SV1HUbezltr4wPvP6ugFxEnXALS5rDR03mnYG0kU3R/hLPilGWYz6WuZFnylIGvOJFiYCED+dh9V9/p2afhIkzxLc+vySIyjx0yQSJCfasvq8AYiTnM+w+EGJDxCpwnoQ0lOQIAu8iFqOFEF8AJy05uljgC70LHIZUSzxU7lTmkt6/j9HhV35LKb4aZwqPjHeJIjXMiz+kPgoPoC5yoUaA6bWrwylSImID4CFqTWKVowBpSQ+gKK1xiAVYUCpiZ+uqtY48OmAshWN0hQfFKYagU8GlrEIlKr4AAJjDSFeaFvK4qcZa4BQfsGiDMSHsO4BZSI+pA0IFWUkPpC6FnTBr+ARLBZyFyMYck2S59zsNmKGP5SI+ECvAXr9iBzBIsqXmMtM6vmy7ybkehuxi246SkN8SBvg+R6QEX86UwCYyiRfTch12imhT36GXqNw3suIA8XP4JcJbsQvoU8+AAq9xsC/vQooCFEeHCR+hqlMYhXzPTPBzZxfauIDCPzLOGi3VwEV5QSnso6ZxmRP9oRc5/xSFT+FdhtBPDMAcju9K3Q6Kudppy+CdBtwPDUA/DUhLOIDJHG6TQI9Bi6Xd+WAHyaESXzAGcmYHmPL6vPAX/3I4KUJIRMf4J31sqw3fSlCjvqVxQsTQig+wG8hvSxF0U4/MxViQkjFR3E6IW1AFdbvgKSfCfMxIaziA4kk+jqkDUh1FlffemNmcGPCKEaEVXxAX0sfez9eHS2YfUGkzuVi2FQmsY4lIRUfJNXsCuhjgIU5AFwOooBcLoqNInuzkXIVH7gS58rPMy+uG9Ak0Y8UfhlUFYXcEClj8VH05b7t8gfcEXN2BVlMPiaUs/gABrO7/+s+tNDwK+DdIAtyY0K5iw/69zjH+vWU62eAiCjI9mCLys2E8hcfBNM68AERg27K12DageOBVZUmmwlhEB84UY15aeCbgwyISjSpsCOYmvozlAkhER+Bp6MSHfTH7pDLUmqxXgR52/+yBtPXhLCID7xVjbVnqF/c8IsZW3TfvWDepEjdcadxK+/j+fMSioH7hk0ALdLYBbzoW1k3ISTiAzyfrZFr1k93Al0PnPW8pMrhjOHahmwDshpgS8MZSTXw8PyOWQWgIN/cKGuzfoBvOr83S/0rAj/yrq6K4Ye5PG8mpwPsJM6vVyjoSREVRlcCqzmXgTl/PXWb7v9sErqozKdluOGDCNacJom+n8vgnE8x093AHwX1ZTFvONBeQR7JVXxweY7fIvV/UlgOXHVdW/i5ppiVzVL3lpuNXP+RtUkajgryBBDoU0dLHAdYs0nqfuN2w7z+ym2WunZFHgeu5LN9yLgmSGOL1B/IZ+OCekS0attCQX5ByL/qmoULgrPS7XNj+lJwk47Num+WwRwGbi00VpnxHwdn8Xel8c+FBCn4Qlu6gNnA7wuNVS4I/FGx5hYqPnh0pbNF6k8muG2+wvcJ98FZgWfiWPM2SfQfXgT04XG2+5cK/BSY6HXsInMG9Ost0uDpyhHPr/VvkvpDFk418Azh2BsU2GOw7vRafPC5U9Zm3TfLwjxbvo+5lbdB17VIvW/HN99blcU0Zh0nuVahifJpi98jsK0aa89Q93G9JLBecbbaJkLNYhAbuCeovC55V5Cdcaa02bIgEUTCwJv1qaps5cDDiq4FllL8ftWXFT1oMLs3surV1Nqo4Chqt8TtGhsXJ7ky3Ut5HgTUVAISwOsCeyysn6WW5xeHkmlXuVN3j77CyLngLDLIIkXvxtuztPeADpCOBJeP9F0gW0xKxoCB7NCDY+NcqhWocWAGUCswlVR/ozHAeD7udXQB+DD98wJwUqHHwLEkTvdIxvSsl2UleR/j/5cYOXgDinhrAAAAAElFTkSuQmCC" />
            </div>
            <br />
            <div class="k-header k-grid-toolbar k-grid-top">
                <small>دستورات:&nbsp;&nbsp;&nbsp;</small>
                <a class="font-medium k-button k-button-icontext " href="/penalties/create?cardId=@Model.cardId" target="_blank">توقیف</a>
                <a class="font-medium k-button k-button-icontext " href="/penalties/index?cardId=@Model.cardId" target="_blank">لیست توقیف شده</a>
                <a class="font-medium k-button k-button-icontext " href="/cardloginhistories/IndexNotExit?cardId=@Model.cardId" target="_blank">لیست خروج پیاده</a>
            </div>
            <br />
            <div class="col-md-6">
                <div class="panel panel-primary ">
                    <div class="panel-heading">
                        <h3 class="panel-title">اطلاعات</h3>
                    </div>
                    <div class="panel-body">
                        <div class="form-horizontal">
                            <div class="form-group">
                                @Html.LabelFor(model => model.DriverFirstName, new { @class = "control-label" })
                                @Html.DisplayFor(model => model.DriverFirstName, new { @id = "DriverFullName" })
                                @Html.ValidationMessageFor(model => model.DriverFirstName)
                            </div>
                            <div class="form-group">
                                @Html.LabelFor(model => model.DriverLastName, new { @class = "control-label" })
                                @Html.DisplayFor(model => model.DriverLastName, new { @id = "DriverFullName" })
                                @Html.ValidationMessageFor(model => model.DriverLastName)
                            </div>
                            <div class="form-group">
                                @Html.LabelFor(model => model.Driver.NationalCode, new { @class = "control-label" })
                                @Html.DisplayFor(model => model.Driver.NationalCode)
                                @Html.ValidationMessageFor(model => model.Driver.NationalCode)
                            </div>
                            <div class="form-group">
                                @Html.LabelFor(model => model.Driver.BirthDate, new { @class = "control-label" })

                                @if (Model.Driver.BirthDate.HasValue)
                                {
                                    date = DateTime.Now.Date.Subtract(Model.Driver.BirthDate ?? DateTime.Now).TotalDays / 365;
                                    @Model.Driver.BirthDate.ToShamsi('a')
                                    @Html.Raw(" &nbsp;&nbsp;&nbsp;&nbsp;")
                                    @Html.Label($"{Convert.ToInt32(date) } سال")
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 ">
                <div class="panel panel-primary ">
                    <div class="panel-heading">
                        <h3 class="panel-title">تاریخ</h3>
                    </div>
                    <div class="panel-body">
                        <div class="form-horizontal">
                            <div class="form-group">
                                @Html.Label("تاریخ", new { @class = "control-label" })
                                @Html.Label($"{DateTime.Now.ToShamsi('s')}")
                            </div>
                            <div class="form-group">
                                @Html.Label("تاریخ(میلادی)", new { @class = "control-label" })
                                @Html.Label($"{DateTime.UtcNow.ToString("MM/dd/yyyy-HH:mm:ss")}")
                            </div>
                            <div class="form-group">
                                @Html.Label("روز", new { @class = "control-label" })
                                @Html.Label($"{Date.DayName(DateTime.Now)}")
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="panel panel-primary ">
                    <div class="panel-heading">
                        <h3 class="panel-title">اطلاعات راننده</h3>
                    </div>
                    <div class="panel-body">
                        <div class="form-horizontal">
                            <div class="form-group">
                                <p> @Html.LabelFor(model => model.Driver.NationalCode, new { @class = "control-label" })</p>
                                <select id="DriverNatCode" name="DriverNatCode" class="DriverSelect form-control k-select" style="width:85%">
                                    <option selected value="@Model.Driver.Id">@Model.Driver.NationalCode</option>
                                </select><span class="p-2"><a class="btn btn-success"  data-toggle="modal" data-target="#driverModal">+</a></span>
                                <p><span id="driverMessage"></span></p> 
                            </div>
                            <div class="form-group">
                                @Html.LabelFor(model => model.DriverFirstName, new { @class = "control-label" })
                                @Html.EditorFor(model => model.DriverFirstName, new { @id = "DriverFullName" })
                                @Html.ValidationMessageFor(model => model.DriverFirstName)
                            </div>
                            <div class="form-group">
                                @Html.LabelFor(model => model.DriverLastName, new { @class = "control-label" })
                                @Html.EditorFor(model => model.DriverLastName, new { @id = "DriverFullName" })
                                @Html.ValidationMessageFor(model => model.DriverLastName)
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 ">
                <div class="panel panel-primary ">
                    <div class="panel-heading">
                        <h3 class="panel-title">اطلاعات کمک راننده</h3>
                    </div>
                    <div class="panel-body">
                        <div class="form-horizontal">
                            <div class="form-group">
                                <p>  @Html.LabelFor(model => model.AssistanceNationalCode, new { @class = "control-label" })</p>
                                @*@Html.EditorFor(model => model.AssistanceName)*@
                                <select id="AssistanceNationalCode" name="AssistanceNationalCode" class="AsistSelect form-control k-select" style="width:85%!important">
                                    <option selected value="@Model.AssistanceId">@Model.AssistanceNationalCode</option>
                                </select> <span class="p-2"><a class="btn btn-success" data-toggle="modal" data-target="#driverModal">+</a></span>
                                <p>

                                    <span id="assistMessage"></span>
                                </p>
                            </div>
                            <div class="form-group">
                                @Html.LabelFor(model => model.AssistanceName, new { @class = "control-label" })
                                @Html.EditorFor(model => model.AssistanceName)

                                @Html.ValidationMessageFor(model => model.AssistanceName)
                            </div>
                            <div class="form-group">
                                @Html.LabelFor(model => model.AssistanceLastName, new { @class = "control-label" })
                                @Html.EditorFor(model => model.AssistanceLastName)
                                @Html.ValidationMessageFor(model => model.AssistanceLastName)
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="panel panel-primary ">
                    <div class="panel-heading">
                        <h3 class="panel-title">اطلاعات خودرو</h3>
                    </div>
                    <div class="panel-body">
                        <div class="form-horizontal">
                            <div class="form-group">
                                @Html.LabelFor(model => model.Pleck, new { @class = "control-label" })
                                <select id="pleck" name="pleck" class="accountSelect form-control input-group  input-lg" style="width:85%!important">
                                    <option selected value="@Model.carId">@Model.Pleck</option>
                                </select> <span class="p-2"><a class="btn btn-success" data-toggle="modal" data-target="#carModal">+</a></span>
                            </div>

                            <div class="form-group">
                                @Html.LabelFor(model => model.Load, new { @class = "control-label" })
                                <input data-val="true" id="Load" name="Load" onkeyup="loadControl(this)"
                                       type="text" value="@Model.Load" class="k-textbox input-group  input-lg">
                                <span id="realLoad"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 ">
                <div class="panel panel-primary ">
                    <div class="panel-heading">
                        <h3 class="panel-title">اطلاعات </h3>
                    </div>
                    <div class="panel-body">
                        <div class="form-horizontal">
                            <div class="form-group col-md-6">
                                @Html.LabelFor(model => model.Type, new { @class = "control-label" })
                                @Html.EditorFor(model => model.Type, new { @class = "form-control  input-lg" })
                                @Html.ValidationMessageFor(model => model.Type)
                            </div>
                            <div class="form-group col-md-6">
                                @Html.LabelFor(model => model.Weight, new { @class = "control-label" })

                                <input data-val="true" id="Weight" name="Weight"
                                       type="text" value="@Model.Weight" class="k-textbox input-group  input-lg">
                                @Html.ValidationMessageFor(model => model.Weight)
                            </div>
                        </div>
                        <div class="row resType p-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center">
            <button type="submit" id="btnSave" class="btn btn-lg btn-success">ثبت نهایی</button>
        </div>
    </form>

</div>



<!-- Modal -->
<div class="modal fade" id="driverModal" role="dialog">
    <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" id="modalClose" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">افزودن راننده</h4>
            </div>
            <div class="modal-body" id="modalBody">
                @Html.Action("CreatePartial","Drivers")
            </div> 
        </div>

    </div>
</div>


<!-- Modal -->
<div class="modal fade" id="carModal" role="dialog">
    <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" id="modalClose" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">افزودن ماشین</h4>
            </div>
            <div class="modal-body" id="modalBody">
                @Html.Action("CreatePartial","cars")
            </div> 
        </div>

    </div>
</div>





<script src="~/Scripts/select2.min.js"></script>
<script>
    $(document).ready(function () {
        var selData = $(".accountSelect").select2({
            ajax: {
                url: '/cards/GetPleckList',
                data: function (params) {
                    return {
                        q: params.term// search term
                    };
                },
                processResults: function (data) {
                    return {
                        dropdownParent: $(".accountSelect"),
                        results: $.map(data.items, function (obj) {
                            return {
                                id: obj.Id, text: obj.Text // <- this is what was done to fix the issue
                            };
                        })
                    };
                },
                initSelection: function (element, callback) {
                    var data = { id: element.val(), text: element.val() };
                    callback(data);
                }
            }
        });

        $('.accountSelect').on("change", function (e) {

            var lastValue = e.currentTarget.value;
            var lastText = e.currentTarget.textContent;
            $.post("/Cards/GetCarType",
                {
                    q: lastValue
                },
                function (data, status) {
                    //alert("Data: " + data + "\nStatus: " + status);
                    //console.log(data.Type, data.Weight)
                      console.log(data.Err)
                    if (data.Err === true) {
                        $('.resType').html(data.ErrMessage)
                        $('.resType').css('color', 'red')
                        $('#btnSave').prop('disabled', true)
                        toastr["warning"](data.ErrMessage)
                    }
                    else {
                        $('.resType').html('')
                        $('#btnSave').prop('disabled', false)
                    }
                        document.getElementById("Type").value = data.Type;
                    document.getElementById("Weight").value = parseFloat(data.Weight);

                });
        });;



        var selData = $(".DriverSelect").select2({
            ajax: {
                url: '/cards/GetDriverList',
                data: function (params) {
                    return {
                        q: params.term// search term
                    };
                },
                processResults: function (data) {
                    return {
                        dropdownParent: $(".DriverSelect"),
                        results: $.map(data.items, function (obj) {
                            return {
                                id: obj.Id, text: obj.Text // <- this is what was done to fix the issue
                            };
                        })
                    };
                },
                initSelection: function (element, callback) {
                    var data = { id: element.val(), text: element.val() };
                    callback(data);
                }
            }
        });
        $(".AsistSelect").select2({
            ajax: {
                url: '/cards/GetDriverList',
                data: function (params) {
                    return {
                        q: params.term,  type:1

                    };
                },
                processResults: function (data) {
                    return {
                        dropdownParent: $(".AsistSelect"),
                        results: $.map(data.items, function (obj) {
                            return {
                                id: obj.Id, text: obj.Text // <- this is what was done to fix the issue
                            };
                        })
                    };
                },
                initSelection: function (element, callback) {
                    console.log(element);
                    var data = { id: element.val(), text: element.val() };
                    callback(data);
                }
            }
        });

        $('.DriverSelect').on("change", function (e) {

            var lastValue = e.currentTarget.value;
            var lastText = e.currentTarget.textContent;
            $.post("/Cards/GetDriver",
                {
                    q: lastValue
                },
                function (data, status) {
                    //alert("Data: " + data + "\nStatus: " + status);
                    document.getElementById("DriverFirstName").value = data.DriverFirstName;
                    document.getElementById("DriverLastName").value = data.DriverLastName;
                    if (!(data.IsAllow)) {
                        $('#btnSave').prop('disabled', true)
                        toastr["warning"](data.Message)
                        $('#driverMessage').html(data.Message)
                    }
                    else {
                        $('#btnSave').prop('disabled', false)
                        $('#driverMessage').html('')
                    }
                });
        });

        $('.AsistSelect').on("change", function (e) {

            var lastValue = e.currentTarget.value;
            var lastText = e.currentTarget.textContent;
            $.post("/Cards/GetDriver",
                {
                    q: lastValue,type:1
                },
                function (data, status) {
                    //alert("Data: " + data + "\nStatus: " + status);
                    console.log(data.DriverFirstName, data.DriverLastName)
                    document.getElementById("AssistanceName").value = data.DriverFirstName;
                    document.getElementById("AssistanceLastName").value = data.DriverLastName;
                    if (!(data.IsAllow)) {
                        $('#btnSave').prop('disabled', true)
                        toastr["warning"](data.Message);
                        $('#assistMessage').html(data.Message)
                    } else {
                        $('#btnSave').prop('disabled', false)
                        $('#assistMessage').html('')
                    }
                });
        });
    });


    function loadControl(inp) {
        var Allowed = @Html.Raw(Configurations.MaxLoadAmount);
        var load = parseInt(document.getElementById("Load").value);
        var weight = parseInt(document.getElementById("Weight").value);
        if ((load - weight) > 0) $('#realLoad').html((load - weight) + " کیلوگرم حداکثر مقدار مجاز ("+ @Html.Raw(Configurations.MaxLoadAmount)+")");
        if ((load - weight)>Allowed) {
            toastr["warning"]('مقدار ورودی بیشتر از حد مجاز ('+ @Html.Raw(Configurations.MaxLoadAmount)+' کیلوگرم) است')
        }
    }

</script>
<script src="~/Scripts/jquery.validate.js"></script>
<script src="~/Scripts/jquery.validate.unobtrusive.js"></script>
