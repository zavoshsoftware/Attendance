
@{
    ViewBag.Title = "اعتبارسنجی";
    Layout = "~/Views/Shared/BackEndLayout/_BackEndLayout.cshtml";
}

@section styles{
    @*<link href="~/Content/select2.min.css" rel="stylesheet" />*@ 
}
<h2>وضعیت احراز هویت</h2>
<hr />
<div class="alert alert-info">
    لطفا کارت را مقابل دستگاه قرار دهید
</div>
 <div id="Messages">

 </div>
@*<div id="pleckDivOld">
    <select id="pleckSelect" class="accountSelect form-control" style="width:300px"></select>
</div>*@
<script src="~/Scripts/jquery.signalR-2.2.2.min.js"></script>
<div class="container">
    @*<input type="text" id="message" />
        <input type="button" id="sendmessage" value="Send" />
        <input type="hidden" id="displayname" />*@
    <br />
    <ul id="discussion">
        @*<li style="display: inline-block;" >
                <div class="card" style="width: 18rem;">
                    <img class="card-img-top"  src="">
                    <div class="card-body">
                        <p class="card-text"></p>
                    </div>
                </div>
            </li>*@

    </ul>
    <div id="user_content">

    </div>



</div>
@section scripts {
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.2.2.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>

        $(function () {
            // Reference the auto-generated proxy for the hub.
            var chat = $.connection.atnHub;
            var imgSuccess = "data:image/png;base64,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";
            var imgCross = "data:image/png;base64,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";
            var resPartial = ""
            // Create a function that the hub can call back to display messages.
            chat.client.addNewMessageToPage = function (id, name, loginId, message) {
                var imgProfile = '';
                if (name == null) {
                    imgProfile = imgCross;
                    name = '';
                    $('#discussion').prepend(
                        '<li /*style="display: inline-block;margin-bottom:30px"*/>'
                        + '<div class="card" /*style="width:40rem"*/>'
                        + '<img class="card-img-top"  src="' + imgProfile + '">'
                        + '<div id = "cardBody" class="card-body">'
                        +'<p class= "card-text"  style = "text-align:justify;margin-top:10px" > '
                        + name + ' ' + message + '</p>'
                        + '</div > '
                        + '</div>'
                        + '</li>');
                }
                else {
                    imgProfile = imgSuccess;
                    $.get("/cards/authenticateform?id=" + loginId, function (data) {
                        resPartial = data;
                        console.log(data)
                    });
               
                const parser = new DOMParser();
                //alert(name);
                    setTimeout(function () {
                        // Add the message to the page.
                        $('#discussion').prepend(
                            '<li /*style="display: inline-block;margin-bottom:30px"*/>'
                            + '<div class="card" /*style="width:40rem"*/>'
                            //+ '<img class="card-img-top"  src="' + imgProfile + '">'
                            + '<div id = "cardBody" class="card-body">'
                            //+'<p class= "card-text"  style = "text-align:justify;margin-top:10px" > '
                            //+ name + ' ' + message + '</p>'
                            + '<div class="panel panel-primary" >'
                            + '<div class="panel-heading">'
                            + '<h3 class= "panel-title" >' + name + ' ' + message + '</h3 ></div>'
                            + ' <div class="panel-body">'
                            + '' + resPartial + ''
                            + '</div > '
                            + '</div > '
                            + '</div > '
                            + '</div>'
                            + '</li>');
                    }, 1500);
                     
                }
            };

            //Send Alarm if current user had a login thats have not exit date
            chat.client.Alarm = function (id, message) {
                console.log(id, message);
                //setInterval(10, function () {
                //    $('#Message').append(
                //        '<div id="'
                //        +
                //          id
                //        +'" class = "alert alert-danger">'
                //        + message
                //        + '</div>'
                //    );
                //})
                $('#Messages').prepend(
                      '<div class = "container row">'
                    + '<div class="alert alert-danger">'
                    + '<p>'
                    + message
                    + '</p>'
                    + '</div>'
                    + '</div>' );
            };

            chat.client.Exit = function (id, message) {
                console.log(id, message);
                 
                var url = '/cards/LoginHistoryDetials/' + id;  
                var link = document.createElement('a');
                link.href = url; 
                link.target = "_blank"
                link.id = String(id);
                document.body.appendChild(link);
                //link.click();
                document.getElementById(String(id)).click();
            };

           

            // Set initial focus to message input box.
            $('#message').focus();
            // Start the connection.
            $.connection.hub.start().done(function () {
                 
            });
        });
        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }
    </script>

    @*<script src="~/Scripts/select2.min.js"></script>

    <script>
        $(document).ready(function () {
            
            $(".accountSelect").select2({
                ajax: {
                    url: '/cards/GetPleckList',
                    width: '300',
                    data: function (params) {
                        return {
                            q: params.term// search term
                        };
                    },
                    processResults: function (data) {
                        return {
                            results: $.map(data.items, function (obj) {
                                return {
                                    id: obj.Id, text: obj.Text // <- this is what was done to fix the issue
                                };
                            })
                        };
                    }
                }
            });
        });
    </script>*@
}
